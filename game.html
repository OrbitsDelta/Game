<script>
    // Инициализация Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if (tg) {
        tg.expand();
    }

    // Состояние пользователя
    let isLoggedIn = true;

    // Элементы DOM
    const profileBtn = document.getElementById('profileBtn');
    const profileModal = document.getElementById('profileModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const confirmModal = document.getElementById('confirmModal');
    const closeProfileModal = document.getElementById('closeProfileModal');
    const logoutBtn = document.getElementById('logoutBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogout');
    const cancelLogoutBtn = document.getElementById('cancelLogout');

    // Элементы профиля
    const profileAvatar = document.getElementById('profileAvatar');
    const profileName = document.getElementById('profileName');
    const gameName = document.getElementById('gameName');
    const regDate = document.getElementById('regDate');
    const userStatus = document.getElementById('userStatus');

    // Получаем имя из URL или Telegram
    function getUserName() {
        const params = new URLSearchParams(window.location.search);
        const name = params.get('name');

        if (name) {
            return decodeURIComponent(name);
        }

        if (tg?.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            return user.first_name + (user.last_name ? ' ' + user.last_name : '');
        }

        return 'Гость';
    }

    // Устанавливаем данные профиля
    function setupProfile() {
        const userName = getUserName();

        // Устанавливаем имя
        profileName.textContent = userName;
        gameName.textContent = userName;

        // Устанавливаем аватар
        if (tg?.initDataUnsafe?.user?.photo_url) {
            profileAvatar.src = tg.initDataUnsafe.user.photo_url;
        } else {
            profileAvatar.src = 'https://cdn-icons-png.flaticon.com/512/147/147144.png';
        }

        // Устанавливаем дату регистрации
        regDate.textContent = new Date().toLocaleDateString();

        // Обновляем статус
        updateLoginStatus();
    }

    // Обновление статуса входа
    function updateLoginStatus() {
        if (isLoggedIn) {
            userStatus.textContent = 'Авторизован';
            userStatus.style.color = '#0f0';
        } else {
            userStatus.textContent = 'Не авторизован';
            userStatus.style.color = '#f55';
        }
    }

    // Показать модальное окно профиля
    function showProfileModal() {
        profileModal.style.display = 'block';
        modalOverlay.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    // Скрыть модальное окно профиля
    function hideProfileModal() {
        profileModal.style.display = 'none';
        modalOverlay.style.display = 'none';
        document.body.style.overflow = '';
    }

    // Показать окно подтверждения выхода
    function showConfirmModal() {
        confirmModal.style.display = 'block';
        modalOverlay.style.display = 'block';
        profileModal.style.display = 'none';
    }

    // Скрыть окно подтверждения выхода
    function hideConfirmModal() {
        confirmModal.style.display = 'none';
        modalOverlay.style.display = 'none';
        document.body.style.overflow = '';
    }

    // Обработчик выхода из аккаунта
    function handleLogout() {
        isLoggedIn = false;

        // Удаляем сохраненное имя
        localStorage.removeItem('playerName');

        // Сброс данных пользователя
        profileName.textContent = 'Гость';
        gameName.textContent = 'Не указано';
        profileAvatar.src = 'https://cdn-icons-png.flaticon.com/512/147/147144.png';
        regDate.textContent = 'Не указана';
        updateLoginStatus();

        // Закрываем все модальные окна
        hideConfirmModal();

        // Переадресация через 1 секунду
        setTimeout(() => {
            window.location.href = 'Page1.html';
        }, 1000);
    }

    // Проверка авторизации при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        const params = new URLSearchParams(window.location.search);
        const name = params.get('name');
        
        // Если нет имени в URL, но есть в localStorage
        if (!name && localStorage.getItem('playerName')) {
            window.location.href = 'game.html?name=' + encodeURIComponent(localStorage.getItem('playerName'));
            return;
        }
        
        // Если нет ни имени в URL, ни в localStorage
        if (!name && !localStorage.getItem('playerName')) {
            window.location.href = 'Page1.html';
            return;
        }
        
        // Инициализация профиля
        setupProfile();

        // Обработчики событий
        profileBtn.addEventListener('click', showProfileModal);
        closeProfileModal.addEventListener('click', hideProfileModal);
        logoutBtn.addEventListener('click', showConfirmModal);
        cancelLogoutBtn.addEventListener('click', hideConfirmModal);
        confirmLogoutBtn.addEventListener('click', handleLogout);

        // Обработчик клика по оверлею
        modalOverlay.addEventListener('click', () => {
            if (confirmModal.style.display === 'block') {
                hideConfirmModal();
            } else if (profileModal.style.display === 'block') {
                hideProfileModal();
            }
        });

        // Закрытие по ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (confirmModal.style.display === 'block') {
                    hideConfirmModal();
                } else if (profileModal.style.display === 'block') {
                    hideProfileModal();
                }
            }
        });
    });
</script>
